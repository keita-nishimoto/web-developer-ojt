# 課題2（ユーザー登録を完了させる）

[ojt-php](https://github.com/keitakn/ojt-php) をベースに開発を進めて行きましょう。

JavaScriptの時と同じようにリポジトリをGitHubにフォークする等をして自分の開発スペースを確保して下さい。

仮ユーザー登録（`/preregistration`）からメールアドレスを入れて、仮ユーザー登録の手続きを済ませて下さい。

すると「仮ユーザー登録完了のお知らせ」というメールが届きます。

下記のような画面が表示されるので、ここからユーザー登録を完了させて下さい。

![task2-1](https://user-images.githubusercontent.com/11032365/37466632-9751476c-28a1-11e8-99df-dcff5d7b8efc.png)

## ユーザー登録の流れ

ユーザー登録は以下の流れで行います。

1. ゲストユーザーが `/preregistration` に遷移する
1. ゲストユーザーがメールに記載された認証トークン付きのURLに遷移する
1. ユーザーがパスワードを入力する
1. 確認画面が表示されるので「登録する」を押すと登録が完了する（戻るを押すと前の画面に戻る）

## アウトプット

ユーザー登録が完了しDBにユーザー情報が作成されるプログラムを作成する事。

## 完了条件

仕様として以下の条件を満たして下さい。

- パスワードは「半角英小文字、大文字数字をそれぞれ一種類以上含む8文字以上100文字以下」とする事
- DBに保存するパスワードは不可逆な形で保存する事
- ユーザーIDは連番数値でユニークになるよう設計する事
- 既に登録済のメールアドレスは登録出来ないようにする事
- 「戻る」を押した時にユーザーが入力した値をフォームに引き継げている事
- URLに含まれているトークンが有効期限切れの場合はエラー画面を出力し、再度の仮ユーザー登録を促す事
- 登録完了後は `preregistrations.is_registered` が1に更新されている事
- 一度ユーザー登録完了したトークンはユーザー登録のフローに進めないよう制御する事

メンターのコードレビューで承認を得た時点で完了とします。

## ヒント

### パスワードのハッシュ化について

パスワードは非常に重要な情報です。

その為、ハッシュ値を計算して保存し例えシステムの管理者であってもユーザーのパスワードが何か分からない状況を作り出す事はマストです。

PHPの場合は [2018年のパスワードハッシュ](https://qiita.com/rana_kualu/items/3ef57485be1103362f56) という記事が参考になります。

たまに暗号化とハッシュ化を混合している人がいますが、この2つは明確な別物です。

パスワードを暗号化して保存するのはアンチパターンです。（ハッシュ値を保存するのが正しい）

この2つの違いについて把握しておきましょう。

ちなみに近年では [Amazon Cognito ユーザープール](https://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/cognito-user-identity-pools.html) のような安全にユーザーの個人情報を保存出来るサービスもあります。

このようなサービスが成り立つのも、それだけパスワードのような情報を安全に保管する事が極めて難しい事を表していると言えます。

筆者の個人的な見解だとパスワード認証を避けられるなら実装は避けるべきであり以下のような代替手段を使うのが良いと考えます。

- ソーシャルログイン（GoogleやTwitterによるログイン）
- [Amazon Cognito ユーザープール](https://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/cognito-user-identity-pools.html)

しかしまだパスワード認証が必要な場面も多いので実装方法を押さえておく事は必要です。

### オブジェクト指向について

ここからの課題はオブジェクト指向の基礎を押さえながら開発しましょう。

書籍ですが [現場で役立つシステム設計の原則](http://gihyo.jp/book/2017/978-4-7741-9087-7) という書籍がオススメです。

- [初心者向けに徹底解説！オブジェクト指向とは？](https://eng-entrance.com/what-oop)
- [オブジェクト指向と10年戦ってわかったこと](https://qiita.com/tutinoco/items/6952b01e5fc38914ec4e)

### テーブル設計について

この課題を完了させる為にはDB設計を行う必要があります。

作成したテーブル構造は `ojt-php/database/database.sql` に記載して下さい。メンターのレビュー対象になります。

テーブル設計は非常に奥が深いですが、このレッスンでは以下の点を意識しましょう。

1. テーブル名やカラム名を省略しない事
1. 適切なデータ型を使う事
1. ユニーク制約、NOT NULL制約、外部キー制約を適切に利用する事

命名規則に関しては [データベースオブジェクトの命名規約](https://qiita.com/genzouw/items/35022fa96c120e67c637) に書かれているルールを採用しましょう。

また以下のカラムは必ず全てのテーブルに入れて下さい。

```
`lock_version` int(10) unsigned NOT NULL DEFAULT '0',
`created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
`updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
```

`created_at` は作成日時、`updated_at` は更新された日時が自動で入ります。

後のレッスンで学習しますがActive Record等のORMを利用する際にこれらのカラムが自動生成されます。

システム的にもあると便利なので作成しておきましょう。

`lock_version` は楽観的ロックを行う際に必要です。

「MySQL楽観的ロック」等の単語で調べてみましょう。

# このレッスンで身につける事

- オブジェクト指向プログラミングの実戦
- DB設計の実戦

ユーザーデータを処理してデータベースに保存する処理はWebアプリケーションの基本です。

どのような言語であっても必要なスキルになるのでここで基本を身につけましょう。

開発規模が大きいのでJavaScript課題で行ったようにPRを細かい単位に分割しましょう。

# メンター向け

メンターはプロジェクト構成を受講者に対して説明して下さい。

受講者は不明点や設計方針の相談をメンターに良く相談してから実装して下さい。

このくらいの規模になるとちょっとした認識の齟齬で大きな手戻りが発生する事もありえます。

そうならない為にもPRは細かく、都度レビューを入れながらインクリメンタルに開発するアジャイル的な開発を意識しましょう。

